<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Tour Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 300;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .main-content {
      padding: 40px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .dashboard-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 25px;
      transition: all 0.3s ease;
      border-left: 5px solid;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .card-bookings { border-left-color: #3498db; }
    .card-activities { border-left-color: #2ecc71; }
    .card-revenue { border-left-color: #f39c12; }
    .card-notifications { border-left-color: #e74c3c; }

    .card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .icon-bookings { background: #3498db; }
    .icon-activities { background: #2ecc71; }
    .icon-revenue { background: #f39c12; }
    .icon-notifications { background: #e74c3c; }

    .card-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #2c3e50;
    }

    .card-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .card-subtitle {
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-bottom: 1px solid #dee2e6;
    }

    .section-title {
      font-size: 1.5em;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .filters {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-label {
      font-size: 0.9em;
      color: #6c757d;
      font-weight: 500;
    }

    .form-control {
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      padding: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-weight: 600;
      color: #2c3e50;
    }

    .table-container {
      padding: 25px;
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    .table th {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #f1f2f6;
    }

    .table tbody tr:hover {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .table .form-control {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .notification-form {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      padding: 25px;
      margin-top: 20px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .toast-error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
    }

    .stat-number {
      font-size: 2em;
      font-weight: 700;
      color: #2c3e50;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9em;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      
      .header {
        padding: 20px;
        flex-direction: column;
        gap: 15px;
      }
      
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üéØ Tour Admin Dashboard</h1>
        <p>Manage your tours, bookings, and activities</p>
      </div>
      <div class="user-info">
        <span id="adminEmail">Loading...</span>
        <button id="logout" class="logout-btn">
          üö™ Logout
        </button>
      </div>
    </div>

    <div class="main-content">
      <!-- Dashboard Stats -->
      <div class="dashboard-grid">
        <div class="dashboard-card card-bookings">
          <div class="card-header">
            <div class="card-icon icon-bookings">üìÖ</div>
            <div class="card-title">Total Bookings</div>
          </div>
          <div class="card-value" id="totalBookings">-</div>
          <div class="card-subtitle">Active reservations</div>
        </div>

        <div class="dashboard-card card-activities">
          <div class="card-header">
            <div class="card-icon icon-activities">üé™</div>
            <div class="card-title">Available Tours</div>
          </div>
          <div class="card-value" id="totalActivities">-</div>
          <div class="card-subtitle">Tour packages</div>
        </div>

        <div class="dashboard-card card-revenue">
          <div class="card-header">
            <div class="card-icon icon-revenue">üí∞</div>
            <div class="card-title">Monthly Revenue</div>
          </div>
          <div class="card-value" id="monthlyRevenue">-</div>
          <div class="card-subtitle">This month's earnings</div>
        </div>

        <div class="dashboard-card card-notifications">
          <div class="card-header">
            <div class="card-icon icon-notifications">üîî</div>
            <div class="card-title">Pending Notifications</div>
          </div>
          <div class="card-value" id="pendingNotifications">-</div>
          <div class="card-subtitle">Messages to send</div>
        </div>
      </div>

      <!-- Activity Management -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üé™ Add New Tour Activity</h2>
        </div>
        <form id="addActivityForm" class="form-grid">
          <div class="form-group">
            <label class="form-label">Activity Name *</label>
            <input type="text" id="activityName" class="form-control" placeholder="Enter activity name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Price (USD) *</label>
            <input type="number" id="activityPrice" class="form-control" placeholder="0.00" min="0" step="0.01" required>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="activityCategory" class="form-control">
              <option value="Adventure">Adventure</option>
              <option value="Cultural">Cultural</option>
              <option value="Nature">Nature</option>
              <option value="City Tour">City Tour</option>
              <option value="Food & Drink">Food & Drink</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration (hours)</label>
            <input type="number" id="activityDuration" class="form-control" placeholder="2" min="1" max="24">
          </div>
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Description</label>
            <textarea id="activityDesc" class="form-control" rows="3" placeholder="Describe the activity..."></textarea>
          </div>
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Activity Image *</label>
            <input type="file" id="activityImage" class="form-control" accept="image/*" required>
          </div>
          <div class="form-group" style="grid-column: 1 / -1;">
            <button type="submit" class="btn btn-success">
              <span class="btn-text">‚ú® Add Activity</span>
              <div class="loading" id="addActivityLoading" style="display: none;"></div>
            </button>
          </div>
        </form>
      </div>

      <!-- Booking Management -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üìã Booking Management</h2>
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Filter by Tour</label>
              <select id="tourFilter" class="form-control">
                <option value="">All Tours</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Filter by Date</label>
              <input type="date" id="dateFilter" class="form-control">
            </div>
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <select id="statusFilter" class="form-control">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="filter-group" style="align-self: end;">
              <button id="applyFilter" class="btn btn-primary">üîç Apply</button>
              <button id="clearFilter" class="btn btn-secondary">üóëÔ∏è Clear</button>
              <button id="exportBookings" class="btn btn-warning">üìä Export</button>
            </div>
          </div>
        </div>
        
        <div class="table-container">
          <table class="table" id="bookingsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Tour</th>
                <th>Date</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Revenue</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Notification System -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üì® Send Notification</h2>
        </div>
        <div class="notification-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Recipient Email *</label>
              <input type="email" id="notifyEmail" class="form-control" placeholder="user@example.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">Notification Type</label>
              <select id="notifyType" class="form-control">
                <option value="general">General</option>
                <option value="booking_confirmation">Booking Confirmation</option>
                <option value="tour_reminder">Tour Reminder</option>
                <option value="cancellation">Cancellation</option>
                <option value="promotional">Promotional</option>
              </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Message *</label>
              <textarea id="notifyMessage" class="form-control" rows="4" placeholder="Enter your message..." required></textarea>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <button id="sendNotify" class="btn btn-primary">
                <span>üì§ Send Notification</span>
                <div class="loading" id="sendNotifyLoading" style="display: none;"></div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Details Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <h3>Activity Details</h3>
      <div id="activityDetails"></div>
      <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://tmqxjnegtiuircaxqkof.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcXhqbmVndGl1aXJjYXhxa29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMTIwNTEsImV4cCI6MjA3Mjg4ODA1MX0.Mx-7VrVhR5kxiKwpuBVHyKy1LO278Z3EbcAqWLXX8Yk";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Global variables
    let activities = [];
    let allBookings = [];
    let filteredBookings = [];
    
    // Utility Functions
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount || 0);
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function setLoading(elementId, isLoading) {
      const element = document.getElementById(elementId);
      const text = element.querySelector('.btn-text') || element;
      const loader = element.querySelector('.loading');
      
      if (isLoading) {
        text.style.opacity = '0.5';
        if (loader) loader.style.display = 'inline-block';
        element.disabled = true;
      } else {
        text.style.opacity = '1';
        if (loader) loader.style.display = 'none';
        element.disabled = false;
      }
    }

    // Authentication Check
    async function checkAuth() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        
        if (!session) {
          window.location.href = "admin-login.html";
          return;
        }
        
        document.getElementById('adminEmail').textContent = session.user.email;
        return session;
      } catch (error) {
        console.error('Auth check failed:', error);
        showToast('Authentication failed', 'error');
        window.location.href = "admin-login.html";
      }
    }

    // Load Activities
    async function loadActivities() {
      try {
        const { data, error } = await supabase
          .from("activities")
          .select("*")
          .order("created_at", { ascending: false });
        
        if (error) throw error;
        
        activities = data || [];
        updateTourFilter();
        updateDashboardStats();
        
        return activities;
      } catch (error) {
        console.error('Error loading activities:', error);
        showToast('Failed to load activities', 'error');
        return [];
      }
    }

    // Update tour filter dropdown
    function updateTourFilter() {
      const tourFilter = document.getElementById("tourFilter");
      tourFilter.innerHTML = '<option value="">All Tours</option>';
      
      activities.forEach(activity => {
        const option = document.createElement("option");
        option.value = activity.name;
        option.textContent = `${activity.name} - ${formatCurrency(activity.price)}`;
        tourFilter.appendChild(option);
      });
    }

    // Load Bookings
    async function loadBookings() {
      try {
        const { data, error } = await supabase
          .from("bookings")
          .select("*")
          .order("created_at", { ascending: false });
        
        if (error) throw error;
        
        allBookings = data || [];
        filteredBookings = [...allBookings];
        renderBookings();
        updateDashboardStats();
        
        return allBookings;
      } catch (error) {
        console.error('Error loading bookings:', error);
        showToast('Failed to load bookings', 'error');
        return [];
      }
    }

    // Render Bookings Table
    function renderBookings(bookings = filteredBookings) {
      const tbody = document.querySelector("#bookingsTable tbody");
      tbody.innerHTML = "";
      
      if (bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">No bookings found</td></tr>';
        return;
      }

      bookings.forEach(booking => {
        const activity = activities.find(a => a.name === booking.tour_name);
        const revenue = activity ? activity.price : 0;
        const status = booking.cancelled ? 'cancelled' : 'active';
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <input type="text" value="${booking.full_name || ''}" 
                   data-id="${booking.id}" class="editField form-control" data-field="full_name">
          </td>
          <td>
            <input type="email" value="${booking.email || ''}" 
                   data-id="${booking.id}" class="editField form-control" data-field="email">
          </td>
          <td>
            <input type="text" value="${booking.phone || ''}" 
                   data-id="${booking.id}" class="editField form-control" data-field="phone">
          </td>
          <td>
            <select data-id="${booking.id}" class="editField form-control" data-field="tour_name">
              ${activities.map(a => 
                `<option value="${a.name}" ${a.name === booking.tour_name ? 'selected' : ''}>${a.name}</option>`
              ).join('')}
            </select>
          </td>
          <td>
            <input type="date" value="${booking.tour_date || ''}" 
                   data-id="${booking.id}" class="editField form-control" data-field="tour_date">
          </td>
          <td>
            <span class="status-badge status-${status}">
              ${status === 'active' ? '‚úÖ Active' : '‚ùå Cancelled'}
            </span>
          </td>
          <td>
            <input type="text" value="${booking.notes || ''}" 
                   data-id="${booking.id}" class="editField form-control" data-field="notes">
          </td>
          <td><strong>${formatCurrency(revenue)}</strong></td>
          <td>${formatDate(booking.created_at)}</td>
          <td>
            <button class="btn btn-danger btn-sm deleteBtn" data-id="${booking.id}">üóëÔ∏è</button>
            <button class="btn btn-warning btn-sm cancelBtn" data-id="${booking.id}" 
                    ${booking.cancelled ? 'disabled' : ''}>
              ${booking.cancelled ? '‚ùå' : '‚è∏Ô∏è'}
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Update Dashboard Statistics
    function updateDashboardStats() {
      const totalBookingsEl = document.getElementById('totalBookings');
      const totalActivitiesEl = document.getElementById('totalActivities');
      const monthlyRevenueEl = document.getElementById('monthlyRevenue');
      const pendingNotificationsEl = document.getElementById('pendingNotifications');

      // Total bookings
      const activeBookings = allBookings.filter(b => !b.cancelled);
      totalBookingsEl.textContent = activeBookings.length;

      // Total activities
      totalActivitiesEl.textContent = activities.length;

      // Monthly revenue calculation
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      const monthlyBookings = allBookings.filter(booking => {
        const bookingDate = new Date(booking.created_at);
        return bookingDate.getMonth() === currentMonth && 
               bookingDate.getFullYear() === currentYear && 
               !booking.cancelled;
      });

      const monthlyRevenue = monthlyBookings.reduce((total, booking) => {
        const activity = activities.find(a => a.name === booking.tour_name);
        return total + (activity ? activity.price : 0);
      }, 0);

      monthlyRevenueEl.textContent = formatCurrency(monthlyRevenue);

      // Pending notifications (mock data for now)
      pendingNotificationsEl.textContent = Math.floor(Math.random() * 10);
    }

    // Add Activity Form Handler
    document.getElementById("addActivityForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      setLoading('addActivityLoading', true);

      try {
        const name = document.getElementById("activityName").value.trim();
        const description = document.getElementById("activityDesc").value.trim();
        const price = parseFloat(document.getElementById("activityPrice").value || 0);
        const category = document.getElementById("activityCategory").value;
        const duration = parseInt(document.getElementById("activityDuration").value || 2);
        const file = document.getElementById("activityImage").files[0];

        if (!name) throw new Error("Activity name is required");
        if (!file) throw new Error("Please select an image");
        if (price <= 0) throw new Error("Price must be greater than 0");

        // Check for duplicate activity names
        if (activities.some(a => a.name.toLowerCase() === name.toLowerCase())) {
          throw new Error("An activity with this name already exists");
        }

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
        const filePath = `activities/${fileName}`;

        // Upload to Supabase Storage
        const { error: uploadError } = await supabase.storage
          .from("tour-images")
          .upload(filePath, file);

        if (uploadError) throw new Error(`Image upload failed: ${uploadError.message}`);

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from("tour-images")
          .getPublicUrl(filePath);

        // Save activity
        const { error: insertError } = await supabase
          .from("activities")
          .insert([{ 
            name, 
            description, 
            price, 
            category,
            duration,
            image_url: publicUrl 
          }]);

        if (insertError) throw insertError;

        showToast("‚ú® Activity added successfully!", "success");
        document.getElementById("addActivityForm").reset();
        await loadActivities();

      } catch (error) {
        console.error('Error adding activity:', error);
        showToast(error.message, "error");
      } finally {
        setLoading('addActivityLoading', false);
      }
    });

    // Filter Functions
    document.getElementById("applyFilter").addEventListener("click", () => {
      const tourFilter = document.getElementById("tourFilter").value;
      const dateFilter = document.getElementById("dateFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;
      
      filteredBookings = allBookings.filter(booking => {
        const tourMatch = !tourFilter || booking.tour_name === tourFilter;
        const dateMatch = !dateFilter || booking.tour_date === dateFilter;
        const statusMatch = !statusFilter || 
          (statusFilter === 'active' && !booking.cancelled) ||
          (statusFilter === 'cancelled' && booking.cancelled);
        
        return tourMatch && dateMatch && statusMatch;
      });
      
      renderBookings(filteredBookings);
      showToast(`Filtered ${filteredBookings.length} bookings`, "success");
    });

    document.getElementById("clearFilter").addEventListener("click", () => {
      document.getElementById("tourFilter").value = "";
      document.getElementById("dateFilter").value = "";
      document.getElementById("statusFilter").value = "";
      filteredBookings = [...allBookings];
      renderBookings();
      showToast("Filters cleared", "success");
    });

    // Export Bookings
    document.getElementById("exportBookings").addEventListener("click", () => {
      try {
        const csvData = [
          ['Name', 'Email', 'Phone', 'Tour', 'Date', 'Status', 'Notes', 'Created At']
        ];
        
        filteredBookings.forEach(booking => {
          csvData.push([
            booking.full_name || '',
            booking.email || '',
            booking.phone || '',
            booking.tour_name || '',
            booking.tour_date || '',
            booking.cancelled ? 'Cancelled' : 'Active',
            booking.notes || '',
            formatDate(booking.created_at)
          ]);
        });

        const csvContent = csvData.map(row => 
          row.map(field => `"${field}"`).join(',')
        ).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bookings-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast("üìä Bookings exported successfully!", "success");
      } catch (error) {
        console.error('Export error:', error);
        showToast("Export failed", "error");
      }
    });

    // Send Notification
    document.getElementById("sendNotify").addEventListener("click", async () => {
      setLoading('sendNotifyLoading', true);
      
      try {
        const email = document.getElementById("notifyEmail").value.trim();
        const message = document.getElementById("notifyMessage").value.trim();
        const type = document.getElementById("notifyType").value;

        if (!email) throw new Error("Email is required");
        if (!message) throw new Error("Message is required");

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) throw new Error("Invalid email format");

        const { error } = await supabase.from("notifications").insert([
          { 
            user_email: email, 
            message,
            type,
            status: 'pending',
            created_at: new Date().toISOString()
          }
        ]);

        if (error) throw error;

        showToast("üì§ Notification sent successfully!", "success");
        document.getElementById("notifyEmail").value = "";
        document.getElementById("notifyMessage").value = "";
        document.getElementById("notifyType").value = "general";

      } catch (error) {
        console.error('Notification error:', error);
        showToast(error.message, "error");
      } finally {
        setLoading('sendNotifyLoading', false);
      }
    });

    // Real-time booking alerts
    const bookingSubscription = supabase
      .channel('bookings')
      .on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'bookings' }, 
        (payload) => {
          const newBooking = payload.new;
          showToast(`üéâ New booking: ${newBooking.full_name} booked ${newBooking.tour_name}`, "success");
          loadBookings();
        }
      )
      .subscribe();

    // Event Delegation for Dynamic Elements
    document.addEventListener("click", async (e) => {
      // Delete booking
      if (e.target.classList.contains("deleteBtn")) {
        const id = e.target.dataset.id;
        if (!confirm("üóëÔ∏è Are you sure you want to delete this booking? This action cannot be undone.")) return;
        
        try {
          const { error } = await supabase.from("bookings").delete().eq("id", id);
          if (error) throw error;
          
          showToast("üóëÔ∏è Booking deleted successfully", "success");
          await loadBookings();
        } catch (error) {
          console.error('Delete error:', error);
          showToast("Failed to delete booking", "error");
        }
      }

      // Cancel booking
      if (e.target.classList.contains("cancelBtn")) {
        const id = e.target.dataset.id;
        const booking = allBookings.find(b => b.id == id);
        
        if (booking.cancelled) return;
        
        if (!confirm("‚è∏Ô∏è Are you sure you want to cancel this booking?")) return;
        
        try {
          const { error } = await supabase
            .from("bookings")
            .update({ cancelled: true })
            .eq("id", id);
            
          if (error) throw error;
          
          showToast("‚è∏Ô∏è Booking cancelled successfully", "success");
          await loadBookings();
        } catch (error) {
          console.error('Cancel error:', error);
          showToast("Failed to cancel booking", "error");
        }
      }
    });

    // Auto-update booking fields
    document.addEventListener("change", async (e) => {
      if (e.target.classList.contains("editField")) {
        const id = e.target.dataset.id;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        try {
          const { error } = await supabase
            .from("bookings")
            .update({ [field]: value })
            .eq("id", id);
            
          if (error) throw error;
          
          // Update local data
          const bookingIndex = allBookings.findIndex(b => b.id == id);
          if (bookingIndex !== -1) {
            allBookings[bookingIndex][field] = value;
          }
          
          // Show subtle feedback
          e.target.style.background = '#d4edda';
          setTimeout(() => {
            e.target.style.background = '';
          }, 1000);
          
        } catch (error) {
          console.error('Update error:', error);
          showToast("Failed to update booking", "error");
          // Revert the change
          await loadBookings();
        }
      }
    });

    // Logout functionality
    document.getElementById("logout").addEventListener("click", async () => {
      if (!confirm("üö™ Are you sure you want to logout?")) return;
      
      try {
        await supabase.auth.signOut();
        showToast("üëã Logged out successfully", "success");
        setTimeout(() => {
          window.location.href = "sign-in.html";
        }, 1000);
      } catch (error) {
        console.error('Logout error:', error);
        showToast("Logout failed", "error");
      }
    });

    // Modal functions
    window.closeModal = function() {
      document.getElementById('activityModal').classList.remove('show');
    }

    window.showActivityDetails = function(activityId) {
      const activity = activities.find(a => a.id === activityId);
      if (!activity) return;
      
      document.getElementById('activityDetails').innerHTML = `
        <img src="${activity.image_url}" alt="${activity.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;">
        <h4>${activity.name}</h4>
        <p><strong>Category:</strong> ${activity.category || 'N/A'}</p>
        <p><strong>Duration:</strong> ${activity.duration || 'N/A'} hours</p>
        <p><strong>Price:</strong> ${formatCurrency(activity.price)}</p>
        <p><strong>Description:</strong> ${activity.description || 'No description available'}</p>
        <p><strong>Created:</strong> ${formatDate(activity.created_at)}</p>
      `;
      
      document.getElementById('activityModal').classList.add('show');
    }

    // Click outside modal to close
    document.getElementById('activityModal').addEventListener('click', (e) => {
      if (e.target.id === 'activityModal') {
        closeModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Initialize Application
    async function initApp() {
      try {
        showToast("üöÄ Loading dashboard...", "success");
        
        await checkAuth();
        await loadActivities();
        await loadBookings();
        
        showToast("‚úÖ Dashboard loaded successfully!", "success");
      } catch (error) {
        console.error('App initialization error:', error);
        showToast("‚ùå Failed to load dashboard", "error");
      }
    }

    // Auto-refresh data every 5 minutes
    setInterval(async () => {
      try {
        await loadBookings();
        console.log('Data refreshed automatically');
      } catch (error) {
        console.error('Auto-refresh error:', error);
      }
    }, 5 * 60 * 1000);

    // Start the application
    initApp();

  </script>
</body>
</html>
