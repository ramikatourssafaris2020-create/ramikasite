<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tour Booking</title>
<style>
body { font-family: Arial; padding: 20px; }
form input, form select, form button { display: block; margin: 10px 0; padding: 8px; width: 250px; }
.tour-card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
</style>
</head>
<body>
<h2>Book a Tour</h2>

<form id="bookingForm">
  <input type="text" id="full_name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="tel" id="phone" placeholder="Phone">
  <input type="date" id="tour_date" required>

  <!-- Tour dropdown -->
  <select id="tour_name" required>
    <option value="">Select a Tour</option>
  </select>

  <button type="submit">Book Now</button>
</form>

<div id="toursContainer"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://tmqxjnegtiuircaxqkof.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcXhqbmVndGl1aXJjYXhxa29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMTIwNTEsImV4cCI6MjA3Mjg4ODA1MX0.Mx-7VrVhR5kxiKwpuBVHyKy1LO278Z3EbcAqWLXX8Yk"; // replace with your anon key
const supabase = createClient(supabaseUrl, supabaseKey);

const tourSelect = document.getElementById("tour_name");
const toursContainer = document.getElementById("toursContainer");

// Load tours into dropdown and display with counts
async function loadTours() {
  const { data: tours } = await supabase.from("activities").select("*").order("created_at");
  const { data: bookings } = await supabase.from("bookings").select("*");

  // Populate dropdown
  tourSelect.innerHTML = `<option value="">Select a Tour</option>`;
  tours.forEach(t => {
    tourSelect.innerHTML += `<option value="${t.name}">${t.name}</option>`;
  });

  // Display tours with current bookings
  toursContainer.innerHTML = "";
  tours.forEach(tour => {
    const currentCount = bookings.filter(b => b.tour_name === tour.name).length;
    const card = document.createElement("div");
    card.className = "tour-card";
    card.innerHTML = `
      <h3>${tour.name}</h3>
      <p>${tour.description || ""}</p>
      <p>Price: $${tour.price || 0}</p>
      <p>Current bookings: ${currentCount}</p>
    `;
    toursContainer.appendChild(card);
  });
}

// Handle booking form submit
document.getElementById("bookingForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const booking = {
    full_name: document.getElementById("full_name").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    tour_name: tourSelect.value,
    tour_date: document.getElementById("tour_date").value,
    notes: ""
  };

  if (!booking.tour_name) return alert("Please select a tour!");

  const { error } = await supabase.from("bookings").insert([booking]);
  if (error) return alert("Booking failed: " + error.message);

  alert("Booking successful!");
  loadTours();
  document.getElementById("bookingForm").reset();
});

// Initial load
loadTours();
</script>
</body>
</html>
