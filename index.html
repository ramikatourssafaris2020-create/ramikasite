<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tour Booking</title>
<style>
body { font-family: Arial; padding: 20px; }
form input, form select, form button { display: block; margin: 10px 0; padding: 8px; width: 250px; }
.tour-card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
</style>
</head>
<body>
<h2>Book a Tour</h2>

<form id="bookingForm">
  <input type="text" id="full_name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="tel" id="phone" placeholder="Phone">
  <input type="date" id="tour_date" required>

  <!-- Tour dropdown -->
  <select id="tour_name" required>
    <option value="">Loading tours...</option>
  </select>

  <button type="submit">Book Now</button>
</form>
<h3>Your Notifications</h3>
<div id="notificationsContainer"></div>

<div id="toursContainer"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://tmqxjnegtiuircaxqkof.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcXhqbmVndGl1aXJjYXhxa29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMTIwNTEsImV4cCI6MjA3Mjg4ODA1MX0.Mx-7VrVhR5kxiKwpuBVHyKy1LO278Z3EbcAqWLXX8Yk"; // make sure RLS allows anon select
const supabase = createClient(supabaseUrl, supabaseKey);

const tourSelect = document.getElementById("tour_name");
const toursContainer = document.getElementById("toursContainer");

// Load tours and populate dropdown
async function loadTours() {
  const { data: tours, error: tourError } = await supabase
    .from("activities")
    .select("name, description, price")
    .order("created_at");

  if (tourError) {
    console.error("Error fetching tours:", tourError);
    tourSelect.innerHTML = `<option value="">Failed to load tours</option>`;
    return;
  }

  if (!tours || tours.length === 0) {
    tourSelect.innerHTML = `<option value="">No tours available</option>`;
  } else {
    tourSelect.innerHTML = `<option value="">Select a Tour</option>`;
    tours.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.name;
      opt.textContent = t.name;
      tourSelect.appendChild(opt);
    });
  }

  // Display tours as cards with current bookings
  const { data: bookings } = await supabase.from("bookings").select("*");

  toursContainer.innerHTML = "";
  tours.forEach(tour => {
    const currentCount = bookings.filter(b => b.tour_name === tour.name).length;
    const card = document.createElement("div");
    card.className = "tour-card";
    card.innerHTML = `
      <h3>${tour.name}</h3>
      <p>${tour.description || ""}</p>
      <p>Price: $${tour.price || 0}</p>
      <p>Current bookings: ${currentCount}</p>
    `;
    toursContainer.appendChild(card);
  });
}

// Handle booking form submit
document.getElementById("bookingForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const full_name = document.getElementById("full_name").value;
  const email = document.getElementById("email").value;
  const phone = document.getElementById("phone").value;
  const tour_name = document.getElementById("tour_name").value;
  const tour_date = document.getElementById("tour_date").value;

  if (!tour_name) return alert("Please select a tour!");

  const { error } = await supabase.from("bookings").insert([{ full_name, email, phone, tour_name, tour_date, notes: "" }]);
  if (error) return alert("Booking failed: " + error.message);

  alert("Booking successful!");
  document.getElementById("bookingForm").reset();
  loadTours();
});
const notificationsContainer = document.getElementById("notificationsContainer");
const emailInput = document.getElementById("email"); // user enters email

async function loadNotifications() {
  const email = emailInput.value;
  if (!email) return;

  const { data: notifications, error } = await supabase
    .from("notifications")
    .select("*")
    .eq("user_email", email)
    .order("created_at", { ascending: false });

  if (error) return console.error(error);

  notificationsContainer.innerHTML = notifications.length
    ? notifications.map(n => `<p>ðŸ“£ ${n.message}</p>`).join('')
    : "<p>No notifications</p>";
}

// Load when user types or leaves email input
emailInput.addEventListener("blur", loadNotifications);

// Initial load
loadTours();
</script>
</body>
</html>
