<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tour Booking</title>
<style>
  body { font-family: Arial; padding: 20px; }
  .tour-card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
  .tour-card h3 { margin: 0; }
  .tour-card button { margin-top: 10px; padding: 5px 10px; }
  #notificationsContainer { margin-top: 20px; background: #f5f5f5; padding: 10px; border-radius: 5px; }
</style>
</head>
<body>

<h2>Book a Tour</h2>

<form id="userForm">
  <input type="text" id="full_name" placeholder="Full Name" required><br>
  <input type="email" id="email" placeholder="Email" required><br>
  <input type="tel" id="phone" placeholder="Phone"><br>
  <input type="date" id="tour_date" required><br>
</form>

<div id="toursContainer"></div>

<h3>Your Notifications</h3>
<div id="notificationsContainer">No notifications yet.</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://tmqxjnegtiuircaxqkof.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcXhqbmVndGl1aXJjYXhxa29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMTIwNTEsImV4cCI6MjA3Mjg4ODA1MX0.Mx-7VrVhR5kxiKwpuBVHyKy1LO278Z3EbcAqWLXX8Yk"; // make sure this is the anon key
const supabase = createClient(supabaseUrl, supabaseKey);

const toursContainer = document.getElementById("toursContainer");
const emailInput = document.getElementById("email");
const notificationsContainer = document.getElementById("notificationsContainer");

// Load tours and bookings
async function loadTours() {
  const { data: tours } = await supabase.from("activities").select("*").order("created_at");
  const { data: bookings } = await supabase.from("bookings").select("*");

  toursContainer.innerHTML = "";

  tours.forEach(tour => {
    const currentCount = bookings.filter(b => b.tour_name === tour.name).length;
    const userBooked = bookings.filter(b => 
      b.tour_name === tour.name && b.email === emailInput.value
    ).length;

    const card = document.createElement("div");
    card.className = "tour-card";
    card.innerHTML = `
      <h3>${tour.name}</h3>
      <p>${tour.description || ""}</p>
      <p>Price: $${tour.price || 0}</p>
      <p>Current bookings: ${currentCount}</p>
      <p>${userBooked ? "âœ… You already booked this tour" : ""}</p>
      <button ${userBooked ? "disabled" : ""} data-tour="${tour.name}">
        ${userBooked ? "Booked" : "Book This Tour"}
      </button>
    `;
    toursContainer.appendChild(card);

    // Book button
    card.querySelector("button")?.addEventListener("click", async () => {
      const booking = {
        full_name: document.getElementById("full_name").value,
        email: emailInput.value,
        phone: document.getElementById("phone").value,
        tour_name: tour.name,
        tour_date: document.getElementById("tour_date").value,
        notes: ""
      };
      const { error } = await supabase.from("bookings").insert([booking]);
      if (error) return alert("Booking failed: " + error.message);
      alert("Booking successful!");
      loadTours();
      loadNotifications();
    });
  });
}

// Load notifications for current user
async function loadNotifications() {
  const email = emailInput.value;
  if (!email) {
    notificationsContainer.innerHTML = "No notifications yet.";
    return;
  }

  const { data: notifications, error } = await supabase
    .from("notifications")
    .select("*")
    .eq("user_email", email)
    .order("created_at", { ascending: false });

  if (error) return console.error(error);

  notificationsContainer.innerHTML = notifications.length
    ? notifications.map(n => `<p>ðŸ“£ ${n.message}</p>`).join('')
    : "No notifications yet.";
}

// Reload tours and notifications when email is entered
emailInput.addEventListener("blur", () => {
  loadTours();
  loadNotifications();
});

// Initial load
loadTours();

</script>
</body>
</html>
